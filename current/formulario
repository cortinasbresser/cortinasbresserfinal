document.addEventListener('DOMContentLoaded', function () {
  // Elementos do DOM
  const form = document.getElementById('orcamentoForm');
  const btn = document.getElementById('btnEnviar');
  const loaderModal = document.getElementById('loaderModal');
  
  // Verifica√ß√£o de elementos cr√≠ticos
  if (!form || !btn) {
    console.error('Elementos do formul√°rio n√£o encontrados');
    return;
  }

  console.log('Formul√°rio carregado - JavaScript funcionando'); // Debug

  // Inicializa√ß√£o de modais Bootstrap
  const loaderBootstrapModal = loaderModal?.classList.contains('modal') ? new bootstrap.Modal(loaderModal) : null;

  // Configura√ß√£o do formul√°rio
  form.addEventListener('submit', function(event) {
    console.log('Submit detectado - prevenindo comportamento padr√£o'); // Debug
    handleFormSubmit(event);
  });
  
  // Adiciona valida√ß√£o em tempo real para melhor UX
  setupRealTimeValidation();

  // Fun√ß√£o principal de submit
  async function handleFormSubmit(event) {
    // Prevenir comportamento padr√£o DO FORMUL√ÅRIO
    if (event) {
      event.preventDefault();
      event.stopPropagation();
      event.stopImmediatePropagation();
    }

    console.log('Processando formul√°rio...'); // Debug

    // Valida√ß√£o adicional do telefone antes de verificar todo o formul√°rio
    const telefoneInput = document.getElementById('telefone');
    if (telefoneInput && telefoneInput.value && !validarTelefone(telefoneInput.value)) {
      form.classList.add('was-validated');
      showFloatingAlert('Por favor, informe um n√∫mero de telefone v√°lido com DDD.', 'warning');
      telefoneInput.focus();
      telefoneInput.classList.remove('is-valid');
      telefoneInput.classList.add('is-invalid');
      return false;
    }

    // Verifica se o formul√°rio est√° v√°lido
    if (!form.checkValidity()) {
      form.classList.add('was-validated');
      showInvalidFields();
      
      // Mostra alerta suspenso
      showFloatingAlert('Por favor, preencha todos os campos obrigat√≥rios corretamente.', 'warning');
      return false;
    }

    // Prepara envio
    await submitFormData();
    return false; // Importante: sempre retornar false para forms
  }

  // Fun√ß√£o para validar telefone brasileiro
  function validarTelefone(telefone) {
    if (!telefone) return false;
    
    // Remove todos os caracteres n√£o num√©ricos
    const numeroLimpo = telefone.replace(/\D/g, '');
    
    // Verifica se tem entre 10 e 11 d√≠gitos (com DDD)
    if (numeroLimpo.length < 10 || numeroLimpo.length > 11) {
      return false;
    }
    
    // Verifica se o DDD √© v√°lido (11 a 99)
    const ddd = numeroLimpo.substring(0, 2);
    if (ddd < 11 || ddd > 99) {
      return false;
    }
    
    return true;
  }

  // Fun√ß√£o para formatar telefone
  function formatarTelefone(telefone) {
    if (!telefone) return '';
    
    const numeroLimpo = telefone.replace(/\D/g, '');
    
    if (numeroLimpo.length === 11) {
      return numeroLimpo.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
    } else if (numeroLimpo.length === 10) {
      return numeroLimpo.replace(/(\d{2})(\d{4})(\d{4})/, '($1) $2-$3');
    }
    
    return telefone;
  }

  // Fun√ß√£o para mostrar campos inv√°lidos
  function showInvalidFields() {
    const invalidFields = form.querySelectorAll(':invalid');
    if (invalidFields.length > 0) {
      invalidFields[0].scrollIntoView({ behavior: 'smooth', block: 'center' });
      invalidFields[0].focus();
    }
  }

  // Fun√ß√£o para mostrar alerta suspenso
  function showFloatingAlert(message, type) {
    // Remove alertas existentes
    removeFloatingAlerts();
    
    // Cria o alerta suspenso
    const alertBox = document.createElement('div');
    alertBox.className = `alert alert-${type} alert-dismissible fade show alert-floating`;
    alertBox.innerHTML = `
      <div class="d-flex align-items-center justify-content-center">
        <span class="me-2">${message}</span>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Fechar"></button>
      </div>
    `;
    
    // Adiciona ao body
    document.body.appendChild(alertBox);
    
    // For√ßa reflow para anima√ß√£o
    void alertBox.offsetHeight;
    
    // Adiciona classe para anima√ß√£o de entrada
    alertBox.classList.add('slide-in');
    alertBox.classList.add('show');
    
    // Configura auto-removal ap√≥s 5 segundos
    const autoRemoveTimer = setTimeout(() => {
      removeFloatingAlert(alertBox);
    }, 5000);
    
    // Remove ao clicar no bot√£o de fechar
    const closeBtn = alertBox.querySelector('.btn-close');
    closeBtn.addEventListener('click', () => {
      clearTimeout(autoRemoveTimer);
      removeFloatingAlert(alertBox);
    });
    
    // Remove ao clicar em qualquer lugar do alerta (exceto no bot√£o fechar)
    alertBox.addEventListener('click', (e) => {
      if (!e.target.closest('.btn-close')) {
        clearTimeout(autoRemoveTimer);
        removeFloatingAlert(alertBox);
      }
    });
  }

  // Remove alerta suspenso espec√≠fico com anima√ß√£o
  function removeFloatingAlert(alertBox) {
    if (!alertBox || !alertBox.parentElement) return;
    
    alertBox.classList.remove('slide-in');
    alertBox.classList.add('slide-out');
    
    setTimeout(() => {
      if (alertBox.parentElement) {
        alertBox.remove();
      }
    }, 400);
  }

  // Remove todos os alertas suspensos
  function removeFloatingAlerts() {
    const existingAlerts = document.querySelectorAll('.alert-floating');
    existingAlerts.forEach(alert => {
      removeFloatingAlert(alert);
    });
  }

// Fun√ß√£o de envio dos dados via AJAX
async function submitFormData() {
    console.log('üì§ Enviando formul√°rio via AJAX...');
    
    const form = document.getElementById('orcamentoForm');
    const btnEnviar = document.getElementById('btnEnviar');
    const loaderModal = document.getElementById('loaderModal');
    
    setLoadingState(true);
    
    try {
        const formData = new FormData(form);
        
        // Processa o nome para pegar apenas o primeiro nome
        const nomeCompleto = formData.get('nome');
        const primeiroNome = nomeCompleto ? nomeCompleto.split(' ')[0] : '';
        if (primeiroNome) {
            formData.set('nome', primeiroNome);
        }
        
        console.log('üì® Enviando para enviar.php...');
        const response = await fetch('enviar.php', {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        });
        
        // Verifica se a resposta est√° OK antes de tentar parse JSON
        if (!response.ok) {
            throw new Error(`Erro HTTP: ${response.status}`);
        }
        
        // Tenta fazer parse do JSON
        let data;
        try {
            const text = await response.text();
            console.log('üì® Resposta bruta:', text);
            
            if (!text) {
                throw new Error('Resposta vazia do servidor');
            }
            
            data = JSON.parse(text);
        } catch (parseError) {
            console.error('‚ùå Erro ao parsear JSON:', parseError);
            throw new Error('Resposta inv√°lida do servidor');
        }
        
        console.log('üì® Resposta do servidor:', data);
        
        if (data.status === 'success') {
            handleSuccess(data.message);
        } else {
            throw new Error(data.message || 'Erro ao processar solicita√ß√£o');
        }
        
    } catch (error) {
        console.error('‚ùå Erro no envio:', error);
        
        // Mensagens de erro mais amig√°veis
        let errorMessage = 'Erro de conex√£o. Tente novamente mais tarde.';
        
        if (error.message.includes('HTTP')) {
            errorMessage = 'Erro no servidor. Tente novamente.';
        } else if (error.message.includes('JSON') || error.message.includes('parse')) {
            errorMessage = 'Erro no processamento dos dados. Tente novamente.';
        } else if (error.message) {
            errorMessage = error.message;
        }
        
        handleError(errorMessage);
    } finally {
        setLoadingState(false);
    }
}

  // Fun√ß√£o para gerenciar estado de carregamento
  function setLoadingState(loading) {
    btn.disabled = loading;
    
    // Atualiza texto do bot√£o
    const btnText = btn.querySelector('.btn-text');
    const spinner = btn.querySelector('.spinner-border');
    
    if (btnText) btnText.textContent = loading ? 'Enviando...' : 'Enviar or√ßamento';
    if (spinner) spinner.classList.toggle('d-none', !loading);
    
    // Gerencia modal de loading
    if (loaderBootstrapModal) {
      if (loading) {
        loaderBootstrapModal.show();
      } else {
        loaderBootstrapModal.hide();
      }
    } else if (loaderModal) {
      // Fallback para modal customizado
      if (loading) {
        loaderModal.style.display = 'flex';
        loaderModal.classList.add('show');
      } else {
        loaderModal.style.display = 'none';
        loaderModal.classList.remove('show');
      }
      document.body.style.overflow = loading ? 'hidden' : '';
    }
  }

  // Fun√ß√£o para sucesso no envio
  function handleSuccess(message) {
    console.log('Sucesso no envio:', message); // Debug
    
    // Reseta formul√°rio
    form.reset();
    form.classList.remove('was-validated');
    
    // Remove classes de valida√ß√£o de todos os campos
    const campos = form.querySelectorAll('.is-valid, .is-invalid');
    campos.forEach(campo => {
      campo.classList.remove('is-valid', 'is-invalid');
    });
    
    // Remove alertas existentes
    removeFloatingAlerts();
    
    // Mostra alerta suspenso de sucesso
    showFloatingAlert('‚úÖ ' + message, 'success');
    
    // Rola para o topo do formul√°rio
    form.scrollIntoView({ behavior: 'smooth' });
  }

  // Fun√ß√£o para tratamento de erro
  function handleError(message) {
    console.log('Erro no envio:', message); // Debug
    removeFloatingAlerts();
    showFloatingAlert('‚ùå ' + message, 'danger');
    
    // Mant√©m o foco no formul√°rio
    form.scrollIntoView({ behavior: 'smooth' });
  }

  // Configura valida√ß√£o em tempo real
  function setupRealTimeValidation() {
    const inputs = form.querySelectorAll('input, select, textarea');
    
    inputs.forEach(input => {
      // Valida√ß√£o espec√≠fica para telefone
      if (input.id === 'telefone') {
        input.addEventListener('input', function() {
          // Formata o telefone enquanto digita
          const cursorPosition = this.selectionStart;
          const valorFormatado = formatarTelefone(this.value);
          
          if (valorFormatado !== this.value) {
            this.value = valorFormatado;
            // Mant√©m a posi√ß√£o do cursor
            const newCursorPosition = Math.min(cursorPosition + (valorFormatado.length - this.value.length), valorFormatado.length);
            this.setSelectionRange(newCursorPosition, newCursorPosition);
          }
          
          validateField(this);
        });
        
        // Valida√ß√£o personalizada para telefone
        input.addEventListener('blur', function() {
          if (this.value && !validarTelefone(this.value)) {
            this.classList.remove('is-valid');
            this.classList.add('is-invalid');
          } else {
            validateField(this);
          }
        });
      } else {
        // Valida√ß√£o normal para outros campos
        input.addEventListener('input', function() {
          if (this.classList.contains('is-invalid')) {
            validateField(this);
          }
        });
        
        input.addEventListener('blur', function() {
          validateField(this);
        });
      }
    });
  }

  // Valida campo individual
  function validateField(field) {
    // Valida√ß√£o personalizada para telefone
    if (field.id === 'telefone' && field.value) {
      if (validarTelefone(field.value)) {
        field.classList.remove('is-invalid');
        field.classList.add('is-valid');
      } else {
        field.classList.remove('is-valid');
        field.classList.add('is-invalid');
      }
      return;
    }
    
    // Valida√ß√£o padr√£o para outros campos
    if (field.checkValidity()) {
      field.classList.remove('is-invalid');
      field.classList.add('is-valid');
    } else {
      field.classList.remove('is-valid');
      field.classList.add('is-invalid');
    }
  }

  // Adiciona m√°scara de telefone quando a p√°gina carrega
  const telefoneInput = document.getElementById('telefone');
  if (telefoneInput && telefoneInput.value) {
    telefoneInput.value = formatarTelefone(telefoneInput.value);
  }
});

// Prevenir qualquer submit que possa escapar
document.addEventListener('submit', function(e) {
  if (e.target.id === 'orcamentoForm') {
    e.preventDefault();
    e.stopPropagation();
  }
});

// Google Maps Autocomplete + Mapa (Opcional)
function initMap() {
  const mapElement = document.getElementById("map");
  const input = document.getElementById("endereco");

  if (!mapElement || !input || typeof google === 'undefined') return;

  try {
    const map = new google.maps.Map(mapElement, {
      center: { lat: -23.55052, lng: -46.633308 },
      zoom: 12,
    });

    const autocomplete = new google.maps.places.Autocomplete(input, {
      types: ['address'],
      componentRestrictions: { country: 'br' }
    });

    const marker = new google.maps.Marker({ map });

    autocomplete.addListener("place_changed", () => {
      const place = autocomplete.getPlace();
      if (!place.geometry || !place.geometry.location) return;

      map.setCenter(place.geometry.location);
      map.setZoom(15);
      marker.setPosition(place.geometry.location);
    });

  } catch (error) {
    console.error('Erro ao inicializar mapa:', error);
  }
}

window.initMap = initMap;